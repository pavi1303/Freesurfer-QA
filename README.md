## Table of Contents
- [Introduction](#Introduction)
- [Requirements](#Requirements)
- [Bash scripts](#Bash-scripts)
- [Python scripts](#Python-scripts)
- [Usage](#Usage)
- [Contact and software version](#Contact-and-software-version)

# Introduction
<a name="Introduction"></a>
Contains all the bash scripts and python scripts to perform the Freesurfer QA analysis, generate screenshots, calculate SNR, and generate the various stats measures.

# Requirements
<a name="Requirements"></a>
1. [Freesurfer v6 and later](https://surfer.nmr.mgh.harvard.edu/pub/dist/)
2. Python 3 any stable version.
3. [QA-tools new](https://github.com/Deep-MI/fsqc) and its dependencies
4. [QAtools old](https://surfer.nmr.mgh.harvard.edu/fswiki/QATools) and its dependencies
   
## Bash scripts
<a name="Bash-scripts"></a>
### Main script
1. ***freesurfer_run_main.sh*** - Main bash script that will run the entire Freesurfer pipeline. All it needs is the input folder location with the T1 files.
### Auxiliary scripts
1. ***fs_recon.sh*** - Runs the Freesurfer recon-all pipeline for all the NIFTI images in the input folder.
2. ***fs_hard_failure_check.sh*** - Extracts the recon-all-status.log file for all the subjects run through the Freesurfer pipeline and appends the result to a .txt file.
3. ***freeview_snapshot.sh*** - Scroll through all the subjects to generate screenshots of different processes in the recon-all pipeline (intensity normalization, skull stripping, white matter segmentation, cortical segmentation, etc.). This uses the latest freeview tool to create and save the screenshots instead of using Tksurfer or Tkmedit.
4. ***fs_qa_new.sh*** - This uses the latest [QA-tools python](https://github.com/Deep-MI/fsqc) to compute the various features like SNR, number of holes, etc., The screenshots module is not used since we already obtain them using freeview, only the features are calculated.
5. ***fs_qa_old.sh*** - Calculates the SNR and similar features using the old [QAtools](https://surfer.nmr.mgh.harvard.edu/fswiki/QATools) that was originally developed for Freesurfer V5.3. This tool is currently deprecated but I'm calculating the features to see how far off they're compared to the newer python equivalent used in *fs_qa_new.sh*

## Python scripts
<a name="Python-scripts"></a>
1. ***fs_copy_sub.py*** - This was developed for personal conversion of the T1 scans located and naming them according to the convention **studyID_examdate.nii**. These subjects were all placed in a folder named **fs_input_todaysdate** which formed the input folder for the bash scripts. This script also creates a *Microsoft Excel file* that will host the original name, converted name, and exam date of the respective NIFTI files. You will not need this file unless you encounter a similar conversion scenario.
2. ***gen_QA_html.py*** - This generates one HTML file with the results of the screenshots generated by *freeview_snapshot.sh*. This is for visual QA to analyze the effectiveness of the automated Freesurfer pipeline and to decide/intervene necessarily.

## Usage
<a name="Usage"></a>
### STEP 1
Run the freesurfer_run_main.sh script. Here, provide the user location of the NIFTI files that need to be run through Freesurfer. The rest of the script is completely automatic and will sequentially run all the auxiliary bash scripts mentioned earlier. 
### STEP 2
The last step is to form one QA HTML file per subject. Here, input the location of the folder that has all the screenshots generated by freeview. The process of integrating this within bash to make it more seamless from start to stop is being pursued and will be updated in the near future.
## Example folder structure
## Input directory
![Input file structure with NIFTI files](https://github.com/pavi1303/Freesurfer-QA/blob/main/images/input%20structure.png)
## Output directory
### Overall output structure showing Freesurfer output and QA_results folder
![Overall output structure](https://github.com/pavi1303/Freesurfer-QA/blob/main/images/Overall%20QA%20output%20structure.png)
### recon-all output structure
![Overall output structure](https://github.com/pavi1303/Freesurfer-QA/blob/main/images/recon-all%20output%20structure.png)
### Overall QA output structure showing the calculated features, screenshots, and HTML
![Overall QA output structure](https://github.com/pavi1303/Freesurfer-QA/blob/main/images/Overall%20QA%20output%20structure.png)
### Freeview tool snapshot structure
![Freeview snapshot structure](https://github.com/pavi1303/Freesurfer-QA/blob/main/images/Freeview%20snapshot%20structure.png)
### QA HTML structure
![QA HTML structure](https://github.com/pavi1303/Freesurfer-QA/blob/main/images/QA%20html%20structure.png)

## Contact and software version
<a name="Contact-and-software-version"></a>
1. If you have any questions, or suggestions you might have please reach out to pavithran.giriprakash@gmail.com
2. Freesurfer 7.3.2 and Python 3.8.10 were used in the above process. 
